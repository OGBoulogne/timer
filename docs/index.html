<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nice Timer</title>
<style>
/* reset */
*, *:before, *:after { box-sizing: border-box }
html { font-size: 16px }
body, h1, h2, h3, h4, h5, h6, p, ol, ul { margin: 0; padding: 0; font-weight: normal }
ol, ul { list-style: none }
img { max-width: 100%; height: auto }

/* da style */
body, button {
  cursor: pointer;
  font-family: monospace;
}

#timer.work { font-size: 30vw; font-style: normal }
#timer {
  font-size: 20vw;
  font-style: italic;
  display: flex;
  justify-content: center;
  height: 100vh;
  width: 100vw;
  position: fixed;
  top: 0;
  align-items: center;
  user-select: none;
  transition: opacity 250ms;
}

#min { font-weight: bold }
#sign-in:hover { opacity: 1 }
#sign-in {
  opacity: 0;
  transition: opacity 750ms;
  position: fixed;
  border: 0;
  bottom: 0;
  right: 0;
  z-index: 1;
  transition: opacity 750ms;
}

/* da colors */
#sec { color: #aaa }
@media (prefers-color-scheme: dark) {
  button, body {
    background: #111;
    color: #eee;
  }

  #sec { color: #555 }
}
</style>
</head>
<body>
<button id="sign-in" disabled>sign-in</button>
<div id="timer" class="work"><div id="min">00</div><div id="sec">00</div></div>
<script>
'use strict'
const minEl = document.getElementById('min')
const secEl = document.getElementById('sec')
const timerEl = document.getElementById('timer')
const signInEl = document.getElementById('sign-in')
let _timeout, _db, _work = false

const save = async (now, prev) => {
  if (!_db) {
    const w = Number(localStorage.work === 'work')
    localStorage.stack = `${(localStorage.stack || '')}${now},${prev||0},${w}\n`
    console.log('offline update', localStorage.stack)
    return
  }

  // get prev, update duration
  await _db.timers
    .child(now.toString(36))
    .set({ ts: now, work: localStorage.work === 'work' })
}

const update = () => {
  const start = Number(localStorage.start)
  const now = Date.now()
  const delta = now - Number(localStorage.start)
  timerEl.classList.toggle('work', localStorage.work === 'work')
  minEl.textContent = String(Math.floor(delta / 60000)).padStart(2, '0')
  secEl.textContent = String(Math.floor(delta / 1000) % 60).padStart(2, '0')
  const next = (Math.floor((start + delta) / 1000) + 1)*1000
  clearTimeout(_timeout)
  _timeout = setTimeout(update, next - now)
}

const toggleWork = work => localStorage.work = work ? 'work' : ''

timerEl.addEventListener('click', (e) => {
  const now = Date.now()
  toggleWork(localStorage.work !== 'work')
  save(now, Number(localStorage.start))
  localStorage.start = now
  update()
})

if (localStorage.start) {
  timerEl.style.opacity = 0
  setTimeout(() => timerEl.style.opacity = 1, 15)
  update()
}


// DATABASE
const fetchText = async url => (await fetch(url)).text()
const loadScript = async urls => {
  const files = await Promise.all(urls.map(fetchText))
  const el = document.createElement('script')
  el.innerHTML = files.join('\n')
  document.head.appendChild(el)
}

const load = async () => {
  await loadScript([
    '/__/firebase/7.13.1/firebase-app.js',
    '/__/firebase/7.13.1/firebase-auth.js',
    '/__/firebase/7.13.1/firebase-database.js',
    '/__/firebase/init.js',
  ])
  return firebase.app()
}

const auth = async () => {
  const user = await getUser()
  return user ? { user } : firebase.auth().getRedirectResult()
    .catch(error => ({ error }))
}

const signIn = (e) => {
  // Start a sign in process for an unauthenticated user.
  const provider = new firebase.auth.GithubAuthProvider()
  firebase.auth().signInWithRedirect(provider)
}

const getUser = () => new Promise((s) => {
  firebase.auth().onAuthStateChanged(s)
})

const init = async app => {
  signInEl.disabled = false
  if (!app) {
    signInEl.textContent = `offline, retry`
    signInEl.onclick = () => {
      signInEl.disabled = true
      load().catch(console.error).then(init)
    }
    return
  }
  const { user, error } = await auth()
  signInEl.style.opacity = 1
  if (!user) {
    error && console.dir(error)
    signInEl.onclick = signIn
    return
  }
  _db = false
  signInEl.textContent = `${user.email} sign-out`
  // todo, handle sign out
  setTimeout(() => signInEl.style.opacity = '', 35000)
  const db = firebase.database()
  const timers = db.ref(user.uid)
  const lastTimers = timers.orderByChild('ts').limitToLast(1)


  lastTimers.on('child_added', snap => {
    const { ts, work, ...rest } = snap.val()
  const apply = snap => {
    if (!snap || !snap.val) return
    const { ts, work } = snap.val()
    if (ts < Number(localStorage.start)) return
    localStorage.start = ts
    toggleWork(work)
    update()
  }

  const [last] = Object.values((await lastTimers.once('value')).val() || {})
  last && apply(last)
  lastTimers.on('child_added', apply)

  timers.child(Date.now().toString(36))
  _db = { timers }
}

load().catch(console.error).then(init)


</script>
</body>
</html>