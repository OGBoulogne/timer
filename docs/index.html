<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="title" content="Nice Timer">
  <meta name="description" content="A Nice Timer">
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://nice-timer.web.app/">
  <meta property="og:title" content="Nice Timer">
  <meta property="og:description" content="A Nice Timer">
  <meta property="og:image" content="https://nice-timer.web.app/preview.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="628">

  <!-- Twitter -->
  <meta name="twitter:creator" content="@GodOfMacro">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://nice-timer.web.app/">
  <meta name="twitter:title" content="Nice Timer">
  <meta name="twitter:description" content="A Nice Timer">
  <meta name="twitter:image" content="https://nice-timer.web.app/preview.png">
  <link id="fav" rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;,">
  <title id="title">Nice Timer</title>
<style>
/* font */
@font-face {
  font-family: 'IBM Plex Mono';
  font-style: normal;
  font-weight: 200;
  src: url(data:font/woff2;base64,d09GMgABAAAAAAxkABEAAAAAHwAAAAwJAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGhYbIByBJgZgADQIPgmCcxEQCqxQp14LQAABNgIkA0AEIAWDOgcgDIMCGyQbM1KTeiBTnYkxbuiPX3/+/fxPXfm+pPWSj9B7e9IB2mG0N0hSCMGBNnWKTul0V22ZNlw0adqMr3Tpnc23/0bGJ5tlZ0Yfwi4Z/aQ7haE1EQhCbbpwn6H39B+gq3DtklpJpaRKsTkPFL6IDh4gz74XqinTDpn5lm5/RaddHgEepe51+//vV6u899c1gp/O6SPrEa1TCW3mfoH/7rw1+6vqeaER2hqifjohESIhk8pGciXix5h7nhT097ScB4oeztaoCwLgY5bCQNBKEAu2L6GCKiiubd6NgrLIhCxLJcUdXo/74DduP3Hv+kUMXDx28zJm3RE2lP9RSXXBrzDk4J28fOUSRt4ucPnWpesIxaI4FVjO4KFdphRAamgJsBiKMEMtoZgzjW+qLVjKNIBNHyfQYfTS/BNZmRdzjBfzp8AoEi7gMWfDmi0yuONAK/ezIQoFUZsEfWYoRbBpaBLcEQTUdoWEWIFcXPgPF3urdFaWZd91CtAlH60X91FFgi/ox3a0QWEII3hIP1sEnzbAowvwaBs8ugaPiZ/bZ9Pw2T/4Dgg3ORS3669En4yj7JVD3DeFIviRw5EDhVIm52JLRyMHFjrQhIoceChrlg/XdupBI1OZbjiZypo8e+ykFcMf2+/Ug6dSM1Na7NLnVOPdWtlVJnhoccqYJZGDMCGI6NQgTZ4/lls4b5lU/R855MJN+AF8ZLveoe3TOLCrYhMoJRNb365tPQ6UMZGD52Q9KZNH57rdJfkYb2JiLRjYY5e2qwILk6Z/rjOo7NM0DdJBo1dyqE8jJNiuinWYtrJ8OHH0dPv8nKeDKrj+YoNqUJlAmThyKIabdukkDpQyEQgcBZTQjFyWoakBsf+NrGg/F+BTgPjYay4JsFJzQ1eAJ860yvVAhG/mNzb6lXllMVztLFYbG3Ezv7FUroRlITsai72NjaLn+1c7lv6hZ3/L73/j6a+9HngZY4NEqIAQJzbRF7PAl8A/f45ngMGUqMK0YALIWoHZ02TlMUkfVw8zP1aNSsnyu4ujGBtGFnYIFSLCBuezfZ1agMT3axwJhEp54cMiFFSTYCVWYJb0WgR1KI3JeYUOBo31nHJHOjbV5ZLUpGSoJDm9kyxXw54gCD6Oo8mtxzq9jJcdgPI93twQQtzwvAjnFYhgJdIzVDrJuESLN2p+0bURyjjo/uc21zlBECrIoSzL/k5DJRNJ2Gn+1UVRZXNsLL8xWjqJAV59+SYwVrlpwQgQadL2rmJsWCB0ziXoZW/vJPDHiFvKUAEiLN1xC389DfxibCLBX49Pp1zC3u4Cv4+4uQA0Po+4I5ZgLSBGr0QwJqpsu9EphyAtIKKCQdP3OmLpCTbIq4vBsCf4OM6JLEtZYw4hbv48TS4gHbktWkzGEwPAQ4sufQnDNYkfT80fYmw4IHQPIW6/6VD2d+oj+fCU+nJhaS5AG4yX4UlHG1RtSDEGOoPDBJOxY0OeCSZcIxyu3eqfnb3Vf+3jeld9mLYnDysetj1hpm3bg+x/gwJ+26v/Gm1tvvIdk/0h3dFI+ut93yblTKAJ8k05k+yWV62qLq8rzrTkQlOLnCOZTn1TUc716X8/ntQ73g5cG+vwcvBm7j7xy6uKb1q63JZdFV7sHOGeE1JaVTtrkm+hbqiK8iy9Xu0eW6VPcRj9o4suqG6rL3IubK6rb/E59+yt3rfhfyy+5nXtrX6q6Jtx2/dXuU6ZJusVPikeKvr0ozVsYkSco452N4ku/6aU7nS+PNo5milNcV64Xnzo0GVYBYU2N5MinQvk9ElkTmBwVZ7UHCslPaWyHnt5iwp6pyrCGs6OqTUcYgTB5SIY+D4OMsTj3uAAQXDwZpy4C5z/FgMVJ+DKQeuE507zxSv8aHNDmnmI60dDRJm3ZcO9njRO9i+rqupfRuKe9N6G3pZEWQjl+g+lmRW57kkv8HZP5nLdk17g7Z7M9owVgs5OzkIwFisEnZ1wtQlNHiSROcGSBZ5VLcqT6G+IatQcckScqzGTIr0L5F4+KBVDyus4Xvze3zFQg9KYhcqkLRSGWah0xkxhXTQIbkNtCK6RNdUTOrRt2LbD67/WpDOT+zOHWLaMdvENNPhdODF1dK+XXkYTtg8pGbJnRazF8bks/RBEuHZgr9wt8I2CtDxeSzxZKUKuChpxByoUoESRYDVmVELO0ceqYm+JepyEZ7haH/qFiitlhWPHWLs+Sr+ZupgibPp+/RX3eitohbOWKK4Qys/xG4q6y9nY200tjl8Eu5rMqfdXr6OV2q9JNW24bZN0wv3f+qFLvcRX3n5MvU2leUHBoqQpLEJYhE0lRWrGhn1RZrePzBlarhOlHf9Q0TbYQPqVIT1vMJyXMr5KG8BtIvSf/axsIrsxe6JMNpGtT0Y/fCAWG41GMV525Nfd9Ikjhxcab99qw9puceM29CisnmLDK/ngRCGnGJkTXCUEFPth52VcjzIBv01g1wW2a7fqpCtIjUqwP0zEiX5C9CHJPaatTFDjYhmV4vhV/yge4GxRxsasJqi+2C3ErFaICIHkuaK4TBNKdWBQBRkbJ0iNoqN6UHRBILogM3WbWgTY2FFBqyYIfoLxIa1pSIk6GuqGVLARMCI7LBESkRDNMCscTFgAdKYphjKMpnRTtIW2lCSk/PK6p1W1wmBStFDeY3A8SWIigxHWlRniE+8hDHZo8X27MTUPf0Gl7Ce4fFPFuJJaQdizETMkCTH7kR/6o3aC4ic4fjEt0Ua77HIXUNfqVgJcQgG+JdzYUtzqQF7u+mUyDnN8Y0ZUvbPUDIoJ+2oSSFroKsUvU2/rcEAX9bFBTL1Zx8B0uK9MQEVZ+cDVIuHwEkWgTFEOoxnjoNSd7XupNxaPLtHzG4y0SS6zttb0/pE2ofegTi9t6RWyX10qBEVHFTw0reB7iRZ0C3LdxGJJQeg67FFASfTiwN7mdvV4q9UBGrE2ob0oiPbqa06SWECEcGiSwp9E1IgQ101S8Iho+FXrUJkGxApuFrCw26nnAuU+IcIeQYT9IDSB0kCHGKgAah13pGBQ00A3oEVrkVbIx/KhM1pAXjoEPupWWG41Iw9s0wZ66aMNY2nwEWpZmbvfJ9LFurF9sBPf4FuEDpIe4BJHSWOZSPYOlUaXOAFwiQMAuoSlIi5SmCujmujAEXe8Dkcixty0yuulDrBattfQBQmjsnRaC61x88p8uJIWKYWM6gVRmV6KpbC3QwnkSNpYprKuLJunoSpDFSRwxTWHvIczgkcd3L6TOkFxeGeF/R06MQ6rmsZ42PLwywzi8CYW7O1pts8EtY3bkEypOFGlvpKoxgyVy2QosdHfITuWzJq2R2RCiP6MR4OZv8MRBjOh7/SBgX0BuQv2ygkExmXDMnTWcdjocx3MGKo138ChD5QKznEG3WBGzzmQTMS3qg9uKcDOLcH9gl5t9QBk5PUB8vHlnTn+5sS9G7yx/+mG9NM2cd7nm3+/6eM2P1xbS9cUcbs8GzDSSUel7yEL//8O4spaupYWtx/p7fL4ZxfElTQyhfksZhK9LGIxs5nKMp7mcZ7jBR7kVV7nDZ7k6TAYa9/AOzSzG9U0M0uaIBaOPKfqbP+KkQ1tXX360QIz0gdYDeiz/FIclZjMzUPl+KMKEV8fVemlmuMyVHD+KxzgIKc4zC52sJOjNDKYAQYxgkZmMZl53KmHdfN+GpnEXvaiS2o88qd4G0fYFjQ+zja20p+v+kL2so2Tsvo8DrCfA7jRNE5ylMNsYq6B7RazjR0cYy+bROlg+hl4ihpjRPlSjCnKeB8ud0Q7wq4UQxvlgBmAl+pHOchoYqUdYUud8aDCfsPaXvo903oHMQuYztyzB5aruNriFXiPvQb6dmwPq6AWJmKPUMFq71v1CK9jcQvn2Mx0utWd9J7XsbmGE6xjMp2he/A6Ao9zBftZQJzgWiKf8iQXsYnRuJbEWPpoo0ggriWTcCPHWMpgcS2FhUxmCG1kRWuVFurJEVw6AlxL41mu5RCLGBAtdaYxil4aDwNFXMsQmvmdMudZINqbPMQl7GFuDsaqKdtA65HSeYFrVfAJEI5WmPBhO9H2oO3dYhp6zDaUYHvQ9i7bu20/8D5AxmMjOXbkr5CjHjsGAA==) format('woff2');
}

@font-face {
  font-family: 'IBM Plex Mono';
  font-style: normal;
  font-weight: 500;
  src: url(data:font/woff2;base64,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) format('woff2');
}

/* reset */
*, *:before, *:after { box-sizing: border-box }
html { font-size: 16px }
body, h1, h2, h3, h4, h5, h6, p, ol, ul { margin: 0; padding: 0; font-weight: normal }
ol, ul { list-style: none }
img { max-width: 100%; height: auto }

/* da style */
body, button {
  cursor: pointer;
  font-family: monospace;
  border: none;
  background: transparent;
}

.lock * { opacity: 0 }
.lock #welcome { opacity: 1 }
#min { font-weight: 500 }
#timer {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 30vw;
  font-weight: 200;
  display: flex;
  justify-content: center;
  height: 100vh;
  width: 100vw;
  position: fixed;
  top: 0;
  align-items: center;
  user-select: none;
  transition: opacity 250ms;
}

#message:before { display: block }
#message:before { content: 'Pause session ended' }
.work #message:before { content: 'Work session ended' }
.out-of-range #message { display: initial }
#message {
  display: none;
  font-size: 6vw;
  text-align: center;
}

#welcome {
  font-size: min(6vw, 32px);
  padding: 6vw;
  text-align: center;
  height: 100vh;
}

#toolbar { position: fixed; z-index: 1; display: flex }
#toolbar button { outline: none; fill: currentColor }
#icon {
  z-index: 1000;
  position: fixed;
  font-size: 15vh;
  height: 18vh;
  width: 100vw;
  text-align: center;
  vertical-align: text-bottom;
  bottom: 2vh;
  user-select: none;
}

/* visibility logic */
html.dark #theme-light,
html:not(.dark) #theme-dark,
body:not(.lock) #welcome,
.out-of-range #min,
.out-of-range #sec,
#sign-in:not(.retry) #sign-in-retry,
#sign-in:not(.off) #sign-in-off,
#sign-in.off #sign-in-on,
#sign-in.retry #sign-in-on,
#bell:not(.off) #sound-off,
#bell.off #sound-on,
#install.installed,
#fullscreen:not(.off) #fullscreen-off,
#fullscreen.off #fullscreen-on { display: none }

/* light theme */
body, button, #timer { color: #222 }
body, #timer { background: #fff }
#sec,
#sign-in[disabled],
#sign-in-on,
#theme,
#message:before,
#bell:not(.off) { color: #888 }
.pause #min { color: #04b }
.pause #sec { color: #48f }
#timer.overtime #sec { color: #d75 }
#timer.overtime #min,
#bell.off { color: #c31 }

/* dark theme */
.dark body,
.dark button,
.dark #timer { color: #eee }
.dark body,
.dark #timer { background: #000 }
.dark #sec,
.dark #sign-in[disabled],
.dark #sign-in-on,
.dark #theme,
.dark #message:before,
.dark #bell:not(.off),
.dark #fullscreen { color: #666 }
.dark .pause #min { color: #5bf }
.dark .pause #sec { color: #269 }
.dark #timer.overtime #sec { color: #a42 }
.dark #timer.overtime #min,
.dark #bell.off { color: #f53 }
</style>
</head>
<body class="lock">
<div id="toolbar">
  <button id="sign-in" disabled class="off">
    <svg id="sign-in-retry" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m20 8.4c7.3 0 13.4 5.9 13.4 13.2s-6.1 13.4-13.4 13.4-13.4-6-13.4-13.4h3.4c0 5.6 4.5 10 10 10s10-4.4 10-10-4.5-10-10-10v6.8l-8.4-8.4 8.4-8.4v6.8z"></path></svg>
    <svg id="sign-in-off" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m20 0c-11 0-20 9-20 20 0 8.8 5.7 16.3 13.7 19 1 0.2 1.3-0.5 1.3-1 0-0.5 0-2 0-3.7-5.5 1.2-6.7-2.4-6.7-2.4-0.9-2.3-2.2-2.9-2.2-2.9-1.9-1.2 0.1-1.2 0.1-1.2 2 0.1 3.1 2.1 3.1 2.1 1.7 3 4.6 2.1 5.8 1.6 0.2-1.3 0.7-2.2 1.3-2.7-4.5-0.5-9.2-2.2-9.2-9.8 0-2.2 0.8-4 2.1-5.4-0.2-0.5-0.9-2.6 0.2-5.3 0 0 1.7-0.5 5.5 2 1.6-0.4 3.3-0.6 5-0.6 1.7 0 3.4 0.2 5 0.7 3.8-2.6 5.5-2.1 5.5-2.1 1.1 2.8 0.4 4.8 0.2 5.3 1.3 1.4 2.1 3.2 2.1 5.4 0 7.6-4.7 9.3-9.2 9.8 0.7 0.6 1.4 1.9 1.4 3.7 0 2.7 0 4.9 0 5.5 0 0.6 0.3 1.2 1.3 1 8-2.7 13.7-10.2 13.7-19 0-11-9-20-20-20z"></path></svg>
    <svg id="sign-in-on" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m29.7 8.6q5.3 4.5 5.3 11.4 0 6.3-4.4 10.6t-10.6 4.4-10.6-4.4-4.4-10.6q0-6.9 5.3-11.4l2.4 2.3q-4.3 3.6-4.3 9.1 0 4.8 3.4 8.2t8.2 3.4 8.2-3.4 3.4-8.2q0-5.5-4.3-9z m-8.1-3.6v16.6h-3.2v-16.6h3.2z"></path></svg>
  </button>
  <button id="bell">
    <svg id="sound-off" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m30 24.5l-14.9-15.7c0.4-0.2 0.8-0.4 1.2-0.6h0l0.5-0.2c0.2-0.1 0.5-0.1 0.7-0.2v-1.2c0-1.4 1.1-2.5 2.5-2.5s2.5 1.1 2.5 2.5v1.2c4.8 1.2 7.5 5.4 7.5 10.6v6.1z m-10 12.1c-1.9 0-3.4-1.4-3.4-3.2h6.8c0 1.8-1.5 3.2-3.4 3.2z m-7-26.4c7.4 7.6 14.7 15.1 22 22.7l-2.1 2.1-3.4-3.4h-22.9v-1.6l3.4-3.4v-8.3c0-2.1 0.5-4.1 1.3-5.7l-4.7-4.6 2.2-2.2z"></path></svg>
    <svg id="sound-on" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m30 26.6l3.4 3.4v1.6h-26.8v-1.6l3.4-3.4v-8.2c0-5.2 2.7-9.4 7.5-10.6v-1.2c0-1.4 1.1-2.5 2.5-2.5s2.5 1.1 2.5 2.5v1.2c4.8 1.2 7.5 5.5 7.5 10.6v8.2z m-10 10c-1.9 0-3.4-1.4-3.4-3.2h6.8c0 1.8-1.6 3.2-3.4 3.2z"></path></svg>
  </button>
  <button id="theme">
    <svg id="theme-light" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m20 30q4.1 0 7.1-2.9t2.9-7.1-2.9-7.1-7.1-2.9-7.1 2.9-2.9 7.1 2.9 7.1 7.1 2.9z m13.4-4.5v7.9h-7.9l-5.5 5.4-5.5-5.4h-7.9v-7.9l-5.4-5.5 5.4-5.5v-7.9h7.9l5.5-5.4 5.5 5.4h7.9v7.9l5.4 5.5z"></path></svg>
    <svg id="theme-dark" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m16.6 3.4c9.3 0 16.8 7.4 16.8 16.6s-7.5 16.6-16.8 16.6c-3 0-5.8-0.7-8.2-2.1 5-2.9 8.2-8.3 8.2-14.5s-3.2-11.6-8.2-14.5c2.4-1.4 5.2-2.1 8.2-2.1z"></path></svg>
  </button>
  <button id="fullscreen" class="off">
    <svg id="fullscreen-off" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m23.4 8.4h8.2v8.2h-3.2v-5h-5v-3.2z m5 20v-5h3.2v8.2h-8.2v-3.2h5z m-20-11.8v-8.2h8.2v3.2h-5v5h-3.2z m3.2 6.8v5h5v3.2h-8.2v-8.2h3.2z"></path></svg>
    <svg id="fullscreen-on" preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m26.6 13.4h5v3.2h-8.2v-8.2h3.2v5z m-3.2 18.2v-8.2h8.2v3.2h-5v5h-3.2z m-10-18.2v-5h3.2v8.2h-8.2v-3.2h5z m-5 13.2v-3.2h8.2v8.2h-3.2v-5h-5z"></path></svg>
  </button>
  <button id="install" class="installed">
    <svg preserveAspectRatio="xMidYMid meet" height="50" width="50" viewBox="0 0 40 40"><path d="m8.4 30h23.2v3.4h-23.2v-3.4z m23.2-15l-11.6 11.6-11.6-11.6h6.6v-10h10v10h6.6z"></path></svg>
  </button>
</div>
<div id="welcome"></div>
<div id="icon"></div>
<div id="timer">
  <div id="message"></div>
  <div id="min">00</div><div id="sec">00</div>
</div>
<script>
'use strict'
const V = '06.04.2020'
// get relative time as text
const relatime = ((l,r,f=([u,s],d)=>r.format(~~(d/s),u))=>d=>f(l.find(([u,s])=>Math.abs(d)>s||u[0]=='s'),d))(Object.entries({year:31536e6,month:2628e6,day:864e5,hour:36e5,minute:6e4,second:1e3}),new Intl.RelativeTimeFormat('en',{style:'narrow'}))

// play notes
const play = (() => {
  let _muted = true, _silentSound
  // todo: handle alias = {DF:'CS',EF:'DS',GF:'FS',AF:'GS',BF:'AS'}
  const signs = 'A.AS.B.C.CS.D.DS.E.F.FS.G.GS'.split('.')
  const tempo = 100
  const durations = {B:128,W:64,H:32,Q:16,E:8,S:4,BD:192,WD:96,HD:48,QD:24,ED:12,SD:6}

  // note: exponentialRampToValueAtTime seems borken on FF, so we define our own curve
  const expWave = new Float32Array([...Array(9).keys()].map(n => (Math.exp(n) - 1) / Math.exp(8)).reverse())
  const context = window.AudioContext && new AudioContext()
  const types = ['sine', 'square', 'sawtooth', 'triangle']
  const notes = Object.fromEntries(signs.slice(0,8)
    .flatMap((_,o)=>signs.map((s,n)=>[s+(o+1),55*2**((12*o + n)/12)])))
  const sound = (frequency, type = 'sine', start = 0) => {
    const o = context.createOscillator()
    const g = context.createGain()
    o.type = type
    o.frequency.value = frequency
    o.connect(g)
    g.connect(context.destination)
    o.start(start)
    return g
  }

  const p = !context ? () => {} : melody => {
    if (_muted) return 0
    let delay = context.currentTime
    for (const noteStr of melody.split('+')) {
      const [ note, rest = '' ] = noteStr.split('.')
      const duration = durations[rest.slice(0, -1)] / tempo
      const g = sound(notes[note], types[rest[rest.length - 1]], delay)
      g.gain.setValueCurveAtTime(expWave, delay, duration)
      delay += duration
    }
    return Math.floor((delay - context.currentTime) * 1000)
  }

  p.sound = !context ? () => {} : sound
  p.muted = muted => _muted = Boolean(muted)
  p.keepAlive = !context ? () => {} : off => off
    ? (_silentSound && (_silentSound.disconnect(), _silentSound = undefined))
    : (_silentSound || (_silentSound = play.sound(-22049)))
  p.context = context
  return p
})()

// create dom element
const el = (tag = 'div', props = {}) => Object.assign(document.createElement(tag), props)

// fix local time
const getTime = (() => {
  let offset = Number(localStorage.timeOffset) || 0
  let precision = Number(localStorage.timePrecision) || Infinity
  const calcDiff = async iteration => {
    const seed = Math.random().toString(36).slice(2)
    const url = `https://us-central1-nice-timer.cloudfunctions.net/now?no-cache=${seed}`
    const res = await fetch(url)
    const unixtime = Number(await res.text())
    if (!unixtime || req.status !== 200) return
    const resource = performance
      .getEntriesByType("resource")
      .find(r => r.name === url)

    const diff = resource.responseStart - resource.requestStart
    const fromCache = resource.transferSize == null // not set in safari, fallback to timings
      ? diff < 25 // usually firebase is fairly slow, so something too fast will be discarded
      : resource.transferSize === 0

    if (fromCache || precision < diff || unixtime > 900000) return // we also discard more than 15min diff
    localStorage.timePrecision = precision = diff
    localStorage.timeOffset = offset = unixtime + Math.floor(diff / 2) - end
    if (iteration < 3) return setTimeout(calcDiff, 150, iteration + 1)
  }
  calcDiff(1)
  return () => offset + Date.now()
})()

const store = defaults => {
  const _set = {}, _get = {}
  const stringify = x => (x == null || Number.isNaN(x)) ? '' : String(x)
  for (const [k, value = ''] of Object.entries(defaults)) {
    const json = !'boolean.number.string'.includes(typeof value)
    const make = json ? JSON.parse : value.constructor
    const prep = json ? JSON.stringify : stringify
    _get[k] = localStorage[k] == null ? value : make(localStorage[k])
    _set[k] = x => (_get[k] === x || (localStorage[k] = prep(_get[k] = x)), x)
  }
  return { _get, _set }
}

const getState = () => timerEl.classList.contains('work') ? 'work' : 'pause'
const mobile = /mobi|android|iphone|ipod|ipad/i.test(navigator.userAgent)
const fullscreen = matchMedia('(display-mode: fullscreen)').matches
const standalone = fullscreen || navigator.standalone || matchMedia('(display-mode: standalone)').matches
const dark = matchMedia('(prefers-color-scheme: dark)').matches
const noaudio = !window.AudioContext

const S = 1000, M = 60*S
const durations = {}
const loadHash = () => {
  const [w = 25, p = 5] = location.hash.slice(1).split('-').filter(Boolean).map(Number)
  if (durations.work === w*M || durations.pause === p*M) return
  durations.work = w*M
  durations.pause = p*M
  history.replaceState({}, '', `${location.origin}${location.pathname}${location.search}#${w}-${p}`)
}
loadHash()
addEventListener('hashchange', loadHash)

const { _set, _get } = store({
  ts: 0,
  prev: 0,
  work: '👔',
  pause: '☕',
  sound: 'off',
  stack: [],
  state: 'pause',
  theme: dark ? 'dark' : 'light',
})

const favEl = document.getElementById('fav')
const minEl = document.getElementById('min')
const secEl = document.getElementById('sec')
const bellEl = document.getElementById('bell')
const iconEl = document.getElementById('icon')
const themeEl = document.getElementById('theme')
const timerEl = document.getElementById('timer')
const titleEl = document.getElementById('title')
const signInEl = document.getElementById('sign-in')
const messageEl = document.getElementById('message')
const installEl = document.getElementById('install')
const welcomeEl = document.getElementById('welcome')
const fullscreenEl = document.getElementById('fullscreen')

let _db
const toVal = ref => ref && ref.val && ref.val()
const saveData = data => _db
  ? _db.timers.child(data.ts.toString(36)).set(data)
  : _set.stack([..._get.stack, data])

const delData = ts => _db
  ? _db.timers.child(ts.toString(36)).remove()
  : _set.stack(_get.stack.filter(data => data.ts === ts))

const getData = async ts => _db
  ? toVal(await _db.timers.child(ts.toString(36)).once('value'))
  : _get.stack.find(data => data.ts === ts)

const applyData = data => {
  if (!data) return console.warn(Error(`applyData called with no data`))
  _set.ts(data.ts || 0)
  _set.prev(data.prev || 0)
  _set.state(data.state || 'pause')
  _set[data.state](data.icon)
  _get.ts && cancelAnimationFrame(update)
  _get.ts && requestAnimationFrame(update)
  return data
}

const getCurrent = () => {
  const { ts, prev, state } = _get
  return { ts, prev, state, icon: _get[state] }
}

const switchState = async () => {
  const current = getCurrent()
  const ts = getTime()
  const state = _get.state === 'work' ? 'pause' : 'work'
  const icon = _get[state]
  const next = { icon, prev: current.ts, state, ts }
  if (ts - current.ts < M) {
    const prev = applyData({ icon, prev: 0, state, ts: current.prev })
    return Promise.all([
      getData(prev.ts).then(applyData),
      delData(current.ts),
    ])
  }
  return saveData(applyData(next))
}

const getColor = overtime => {
  if (overtime) return dark ? '#f53' : '#c31'
  if (_get.state === 'work') return dark ? '#fff' : '#000'
  return dark ? '#5bf' : '#04b'
}

const setFav = (canvasEl => {
  const ctx = canvasEl.getContext('2d')
  ctx.font = '84px "IBM Plex Mono", monospace'
  ctx.textAlign = 'center'
  ctx.textBaseline = 'middle'
  favEl.type = 'image/png'

  return (text, overtime) => {
    ctx.clearRect(0, 0, 96, 96)
    ctx.fillStyle = getColor(overtime)
    ctx.fillText(text, 48, 48)
    favEl.href = canvasEl.toDataURL('image/png')
  }
})(el('canvas', { width: '96', height: '96' }))
setFav('00')


// UPDATE DOCUMENT
const timings = [...Array(10).keys()].map(n => n ** 2 * M + 1)
let _timeout
const update = () => {
  // async loop
  Promise.resolve(clearTimeout(_timeout)).finally(() => {
    _timeout = setTimeout(update, (Math.floor((ts + delta) / S) + 1) * S - now)
  })

  const { state, ts } = _get
  const now = getTime()
  const delta = now - ts
  const dur = durations[state]
  const diff = dur - delta
  const overtime = delta > dur
  const left = overtime ? delta : diff + 500
  const min = Math.floor(left / M)
  const sec = Math.floor(left / S) % 60
  const outOfRange = overtime && min > 99

  timerEl.classList.toggle('work', state === 'work')
  timerEl.classList.toggle('pause', state === 'pause')
  timerEl.classList.toggle('overtime', overtime)
  timerEl.classList.toggle('out-of-range', outOfRange)

  if (outOfRange) return messageEl.textContent = relatime(diff)
  overtime && timings.find(t => -diff > t && -diff < t + S) && play('CS6.ED+A7.BD')
  updateIcon(state)
  titleEl.textContent = `${state[0].toUpperCase()}${state.slice(1)}`
  const minText = String(min).padStart(2, '0')
  minEl.textContent = minText
  secEl.textContent = String(sec).padStart(2, '0')
  mobile || setFav(minText, overtime)
}

// ICONS
const icons = {
  pause: ['☕', '📚', '🤸', '💤', '📞', '🌻'],
  work: ['👔', '⚒️', '🎓', '🥼', '✍', '👩‍💻'],
}

const iconIdx = {
  pause: Math.max(icons.pause.indexOf(_get.pause), 0),
  work: Math.max(icons.work.indexOf(_get.work), 0),
}

const updateIcon = (key, icon) => {
  icon == null ? (icon = _get[key]) : _set[key](icon)
  iconEl.textContent = icon
  iconIdx[key] = Math.max(icons[key].indexOf(_get[key]), 0)
}

updateIcon(_get.state)
const nextIcon = () => {
  const i = icons[_get.state]
  const next = (Math.max(i.indexOf(_get[_get.state]), 0) + 1) % i.length
  updateIcon(_get.state, i[next])
  _db && _db.timers.child(_get.ts.toString(36)).set(getCurrent())
}

// THEME
document.documentElement.classList.toggle('dark', _get.theme === 'dark')
const toggleTheme = () => {
  const theme = _set.theme(_get.theme === 'dark' ? 'light' : 'dark')
  document.documentElement.classList.toggle('dark', theme === 'dark')
}

// BELL
noaudio && (bellEl.style.display = 'none')
bellEl.classList.toggle('off', _get.sound === 'off')
play.muted(_get.sound === 'off')
const toggleSound = () => {
  const off = !bellEl.classList.contains('off')
  bellEl.classList.toggle('off', off)
  _set.sound(off ? 'off' : 'on')
  play.muted(off)
  play('A7.ED+B7.ED+CS7.BD')
}

// FULLSCREEN
(fullscreen || !mobile) && (fullscreenEl.style.display = 'none')
const toggleFullScreen = () => {
  const off = document.fullscreenElement === document.documentElement
  fullscreenEl.classList.toggle('off', off)
  mobile && play.keepAlive(!off)
  if (off) return document.exitFullscreen()
  document.documentElement.requestFullscreen()
}

// DATABASE
const fetchText = async url => (await fetch(url)).text()
const loadScript = async urls => {
  const files = await Promise.all(urls.map(fetchText))
  document.head.appendChild(el('script', { innerHTML: files.join('\n') }))
}

const load = async () => {
  await loadScript([
    '/__/firebase/7.13.1/firebase-app.js',
    '/__/firebase/7.13.1/firebase-auth.js',
    '/__/firebase/7.13.1/firebase-database.js',
  ])

  firebase.initializeApp({
    apiKey: 'AIzaSyCrDohraCBHQ1lOYifOowue2sNFb4Q7ysQ',
    authDomain: 'nice-timer.web.app',
    databaseURL: 'https://nice-timer.firebaseio.com',
    messagingSenderId: '876712947752',
    projectId: 'nice-timer',
    storageBucket: 'nice-timer.appspot.com'
  })

  return firebase.app()
}

const signIn = () => firebase.auth().signInWithRedirect(new firebase.auth.GithubAuthProvider())
const getUser = () => new Promise((s) => firebase.auth().onAuthStateChanged(s))
const auth = () => getUser()
  .then(user => user ? { user } : firebase.auth().getRedirectResult())
  .catch(error => ({ error }))


const init = async app => {
  signInEl.disabled = false
  if (!app) {
    signInEl.className = 'retry'
    signInEl.onclick = () => {
      signInEl.disabled = true
      load().catch(console.error).then(init)
    }
    return
  }
  const { user, error } = await auth()
  if (!user) {
    signInEl.className = 'off'
    error && console.dir(error)
    signInEl.onclick = signIn
    return
  }
  signInEl.className = ''
  signInEl.onclick = async () => {
    signInEl.disabled = true
    await firebase.auth().signOut()
    signInEl.disabled = false
    signInEl.className = 'off'
    _db = undefined
  }
  setTimeout(() => signInEl.style.opacity = '', 35000)
  const db = firebase.database()
  const timers = db.ref(user.uid)

  _set.stack([]) // for now, discard the stack if we use online
  const apply = snap => {
    const data = toVal(snap)
    data && applyData(data)
  }

  timers.orderByChild('ts').limitToLast(1).on('value', s => s.forEach(apply))
  _db = { timers }
}

// INSTALL
const upToDate = localStorage.version === V
upToDate || (localStorage.clear(), localStorage.version = V)
navigator.serviceWorker && navigator.serviceWorker.register(`/service.js?v=${V}`)
  .then(registration => upToDate || registration.update())

// UNLOCK
// Sound api may require an interaction, so we interact...
welcomeEl.textContent = mobile ? 'touch to unlock' : 'click or hit any key to unlock'
const unlock = () => {
  removeEventListener('keydown', unlock)
  removeEventListener('click', unlock)
  timerEl.addEventListener('click', switchState)
  bellEl.addEventListener('click', toggleSound)
  iconEl.addEventListener('click', nextIcon)
  themeEl.addEventListener('click', toggleTheme)
  fullscreenEl.addEventListener('click', toggleFullScreen)
  document.body.classList.remove('lock')
  play.muted(false)
  play('CS6.ED')
}

// INIT
applyData(_get.stack[_get.stack.length - 1] || getCurrent())
setTimeout(async () => {
  const skipUnlock = noaudio || _get.sound === 'off' || play.context.currentTime > 0 || !_get.ts
  skipUnlock || addEventListener('keydown', unlock)
  skipUnlock || addEventListener('click', unlock)
  skipUnlock && unlock()
  await init(await load().catch(console.error)).catch(console.error)
})

</script>
</body>
</html>